from common.response import app_ok_p, app_err_p, app_ok, app_err
from common.error_code import Error
from common.utils.http_request import req_get_param_int, req_get_param, req_post_param, req_post_param_int, req_post_param_dict
import common.config

from common.utils.general import SysUtils

# 利用方法存储桶
method_fs = common.config.g_edb_method_fs

class ExploitMethods:
    def count(self):
        count = method_fs.find().count()
        return count

    def query(self, offset, count):
        result_cursor = method_fs.find()
        item_list = list(result_cursor[offset: offset + count])
        items = []
        for item in item_list:
            items.append(SysUtils.grid_out_to_dict(item))
        # item_list = list(result_cursor[offset: offset + count])
        return items

    def fetch(self, edb_id):
        grid_out = method_fs.find_one({'filename': edb_id})
        item = SysUtils.grid_out_to_dict(grid_out)
        if item is None:
            return None

        if item['content_type'] == 'txt':
            item['content'] = grid_out.read().decode('utf-8')
        else:
            item['content'] = None
        item['edb_id'] = edb_id
        return item

