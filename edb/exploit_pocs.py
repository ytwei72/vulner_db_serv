from common.response import app_ok_p, app_err_p, app_ok, app_err
from common.error_code import Error
from common.utils.http_request import req_get_param_int, req_get_param, req_post_param, req_post_param_int, req_post_param_dict
import common.config
from common.utils.general import SysUtils

import re

# 利用方法存储桶
method_fs = common.config.g_edb_method_fs

class ExploitPocs:
    def count(self):
        count = method_fs.find().count()
        return count

    def query(self, offset, count):
        result_cursor = method_fs.find()
        item_list = list(result_cursor[offset: offset + count])
        items = []
        for item in item_list:
            items.append(SysUtils.grid_out_to_dict(item))
        # item_list = list(result_cursor[offset: offset + count])
        return items

    def fetch(self, edb_id):
        grid_out = method_fs.find_one({'filename': edb_id})
        item = SysUtils.grid_out_to_dict(grid_out)
        if item is None:
            return None

        # if item['content_type'] in ['txt']:
        item['content'] = grid_out.read().decode('utf-8')
        # else:
        #     item['content'] = None
        item['edb_id'] = edb_id
        return item

    def fetch_no_content(self, edb_id):
        grid_out = method_fs.find_one({'filename': edb_id})
        item = SysUtils.grid_out_to_dict(grid_out)
        if item is None:
            return None
        return item

    def add(self, edb_id, alias, content):
        type = SysUtils.parse_file_type(alias)
        # 更新POC到 GridFS 存储桶中
        method_fs.put(content.encode(encoding="utf-8"), content_type=type, filename=edb_id, aliases=[alias])
        return True

    def delete(self, edb_id):
        file_item = method_fs.find_one({'filename': edb_id})
        if file_item is None:
            return False
        method_fs.delete(file_item._id)
        return True

    def update(self, edb_id, alias, content):
        # 删除旧的POC
        self.delete(edb_id)

        type = SysUtils.parse_file_type(alias)
        # 更新POC到 GridFS 存储桶中
        method_fs.put(content.encode(encoding="utf-8"), content_type=type, filename=edb_id, aliases=[alias])
        return True

    def search(self, name):
        # 正则表达式匹配整个单词：re.compile(r'\b%s\b' % word, re.IGNORECASE)
        result_cursor = method_fs.find({'aliases': re.compile(r'\b%s\b' % name, re.IGNORECASE)}, {'_id': 0})

        return result_cursor

