from common.response import app_ok_p, app_err_p, app_ok, app_err
from common.error_code import Error
from common.utils.http_request import req_get_param_int, req_get_param, req_post_param, req_post_param_int, req_post_param_dict
import common.config

from common.utils.general import SysUtils

import re

# 利用信息集合
edb_info_col = common.config.g_edb_info_col


class ExploitDB:
    def info_count(self):
        total_count = edb_info_col.count()
        return total_count

    def query(self, offset, count):
        result_cursor = edb_info_col.find({}, {'_id': 0})
        item_list = list(result_cursor[offset: offset + count])
        return item_list

    def search(self, field, value):
        if field in ['os', 'service', 'db', 'PLC']:
            key = 'description'
            # 针对厂商名称做英文转换
            if value == '西门子':
                value = 'siemens'
            elif value == '施耐德':
                value = 'schneider'
            elif value == '菲尼克斯':
                value = 'phoenix'
            elif value == '通用电气' or value == '通用电气软件组态':
                value = 'GE'
        else:
            return None

        # 正则表达式匹配整个单词：re.compile(r'\b%s\b' % word, re.IGNORECASE)
        result_cursor = edb_info_col.find({key: re.compile(r'\b%s\b' % value, re.IGNORECASE)}, {'_id': 0})
        return result_cursor
